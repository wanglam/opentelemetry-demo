# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

otel-logs-pipeline:
  workers: 5
  delay: 10
  source:
    otel_logs_source:
      ssl: false
  processor:
    - add_entries:
        entries:
          - key: "log.attributes.serviceName"
            value_expression: "/serviceName"
            add_when: "/serviceName != null"
    - add_entries:
        entries:
          - key: "serviceName"
            value_expression: "/log.attributes.serviceName"
            overwrite_if_key_exists: true
            add_when: "/serviceName == null"

  buffer:
    bounded_blocking:
  sink:
    - opensearch:
        hosts: ["https://opensearch-node1:9200"]
        username: "admin"
        password: "my_%New%_passW0rd!@#"
        insecure: true
        index_type: custom
        index:  ss4o_logs-otel-%{yyyy.MM.dd}
        bulk_size: 4
        template_type: index-template
        template_content: >
          {
            "index_patterns": [
              "ss4o_logs-otel-*"
            ],
            "template": {
              "mappings": {
                "properties": {
                  "body": {
                    "type": "text"
                  },
                  "droppedAttributesCount": {
                    "type": "long"
                  },
                  "flags": {
                    "type": "long"
                  },
                  "instrumentationScope": {
                    "properties": {
                      "name": {
                        "type": "keyword"
                      }
                    }
                  },
                  "log": {
                    "properties": {
                      "attributes": {
                        "properties": {
                          "address": {
                            "type": "keyword"
                          },
                          "amount": {
                            "type": "keyword"
                          },
                          "cardType": {
                            "type": "keyword"
                          },
                          "contentRoot": {
                            "type": "keyword"
                          },
                          "context": {
                            "type": "keyword"
                          },
                          "envName": {
                            "type": "keyword"
                          },
                          "hostname": {
                            "type": "keyword"
                          },
                          "lastFourDigits": {
                            "type": "keyword"
                          },
                          "level": {
                            "type": "keyword"
                          },
                          "otelServiceName": {
                            "type": "keyword"
                          },
                          "otelSpanID": {
                            "type": "keyword"
                          },
                          "otelTraceID": {
                            "type": "keyword"
                          },
                          "otelTraceSampled": {
                            "type": "boolean"
                          },
                          "pid": {
                            "type": "long"
                          },
                          "productId": {
                            "type": "keyword"
                          },
                          "quantity": {
                            "type": "long"
                          },
                          "request": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "serviceName": {
                            "type": "keyword"
                          },
                          "severity": {
                            "type": "keyword"
                          },
                          "span_id": {
                            "type": "keyword"
                          },
                          "time": {
                            "type": "date",
                            "format": "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS'Z'||yyyy-MM-dd'T'HH:mm:ss.SSS'Z'||strict_date_optional_time||epoch_millis"
                          },
                          "timestamp": {
                            "type": "date",
                            "format": "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS'Z'||yyyy-MM-dd'T'HH:mm:ss.SSS'Z'||strict_date_optional_time||epoch_millis"
                          },
                          "trace_flags": {
                            "type": "keyword"
                          },
                          "trace_id": {
                            "type": "keyword"
                          },
                          "transactionId": {
                            "type": "keyword"
                          },
                          "userId": {
                            "type": "keyword"
                          }
                        }
                      }
                    }
                  },
                  "observedTime": {
                    "type": "date"
                  },
                  "resource": {
                    "properties": {
                      "attributes": {
                        "properties": {
                          "container@id": {
                            "type": "keyword"
                          },
                          "host@arch": {
                            "type": "keyword"
                          },
                          "host@name": {
                            "type": "keyword"
                          },
                          "os@description": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "os@name": {
                            "type": "keyword"
                          },
                          "os@type": {
                            "type": "keyword"
                          },
                          "os@version": {
                            "type": "keyword"
                          },
                          "process@command": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@command_args": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@command_line": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@executable@path": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@owner": {
                            "type": "keyword"
                          },
                          "process@pid": {
                            "type": "long"
                          },
                          "process@runtime@description": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@runtime@name": {
                            "type": "keyword"
                          },
                          "process@runtime@version": {
                            "type": "keyword"
                          },
                          "service@name": {
                            "type": "keyword"
                          },
                          "service@namespace": {
                            "type": "keyword"
                          },
                          "service@version": {
                            "type": "keyword"
                          },
                          "telemetry@auto@version": {
                            "type": "keyword"
                          },
                          "telemetry@sdk@language": {
                            "type": "keyword"
                          },
                          "telemetry@sdk@name": {
                            "type": "keyword"
                          },
                          "telemetry@sdk@version": {
                            "type": "keyword"
                          }
                        }
                      }
                    }
                  },
                  "schemaUrl": {
                    "type": "text",
                    "fields": {
                      "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                      }
                    }
                  },
                  "serviceName": {
                    "type": "keyword"
                  },
                  "severityNumber": {
                    "type": "long"
                  },
                  "severityText": {
                    "type": "keyword"
                  },
                  "spanId": {
                    "type": "keyword"
                  },
                  "time": {
                    "type": "date",
                    "format": "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS'Z'||yyyy-MM-dd'T'HH:mm:ss.SSS'Z'||strict_date_optional_time||epoch_millis"
                  },
                  "traceId": {
                    "type": "keyword"
                  }
                }
              },
              "settings": {
                "index": {
                  "mapping": {
                    "total_fields": {
                      "limit": 10000
                    }
                  },
                  "refresh_interval": "5s"
                }
              }
            },
            "composed_of": [],
            "version": 1
          }

entry-pipeline:
  delay: "100"
  source:
    otel_trace_source:
      ssl: false
  sink:
    - pipeline:
        name: "raw-pipeline"
    - pipeline:
        name: "service-map-pipeline"
raw-pipeline:
  source:
    pipeline:
      name: "entry-pipeline"
  processor:
    - otel_trace_raw:
  sink:
    - opensearch:
        hosts: ["https://opensearch-node1:9200"]
        insecure: true        
        username: "admin"
        password: "my_%New%_passW0rd!@#"
        index_type: trace-analytics-raw
service-map-pipeline:
  delay: "100"
  source:
    pipeline:
      name: "entry-pipeline"
  processor:
    - service_map_stateful:
  sink:
    - opensearch:
        hosts: ["https://opensearch-node1:9200"]
        insecure: true
        username: "admin"
        password: "my_%New%_passW0rd!@#"
        index_type: trace-analytics-service-map
otel-metrics-pipeline:
  workers: 8
  delay: 3000
  source:
    otel_metrics_source:
      health_check_service: true
      ssl: false
  buffer:
    bounded_blocking:
      buffer_size: 1024 # max number of records the buffer accepts
      batch_size: 1024 # max number of records the buffer drains after each read
  processor:
    - otel_metrics:
        calculate_histogram_buckets: true
        calculate_exponential_histogram_buckets: true
        exponential_histogram_max_allowed_scale: 10
        flatten_attributes: false
  sink:
    - opensearch:
        hosts: ["https://opensearch-node1:9200"]
        username: "admin"
        password: "my_%New%_passW0rd!@#"
        insecure: true
        index_type: custom
        index: ss4o_metrics-otel-%{yyyy.MM.dd}
        bulk_size: 4
        template_type: index-template
        template_content: >
          {
            "index_patterns": [
              "ss4o_metrics-*-*"
            ],
            "template": {
              "mappings": {
                "_meta": {
                  "version": "1.0.0",
                  "catalog": "observability",
                  "type": "metrics",
                  "component": "metrics",
                  "correlations" : [
                    {
                      "field": "spanId",
                      "foreign-schema" : "traces",
                      "foreign-field" : "spanId"
                    },
                    {
                      "field": "traceId",
                      "foreign-schema" : "traces",
                      "foreign-field" : "traceId"
                    }
                  ]
                },
                "_source": {
                  "enabled": true
                },
                "dynamic_templates": [
                  {
                    "exemplar_attributes_map": {
                      "mapping": {
                        "type": "keyword"
                      },
                      "path_match": "exemplar.attributes.*"
                    }
                  },
                  {
                    "instrumentation_scope_attributes_map": {
                      "mapping": {
                        "type": "keyword"
                      },
                      "path_match": "instrumentationScope.attributes.*"
                    }
                  }
                ],
                "properties": {
                  "serviceName": {
                    "type": "keyword"
                  },
                  "name": {
                    "type": "keyword",
                    "ignore_above": 256
                  },
                  "attributes": {
                    "type": "object",
                    "properties": {
                      "data_stream": {
                        "properties": {
                          "dataset": {
                            "ignore_above": 128,
                            "type": "keyword"
                          },
                          "namespace": {
                            "ignore_above": 128,
                            "type": "keyword"
                          },
                          "type": {
                            "ignore_above": 56,
                            "type": "keyword"
                          }
                        }
                      }
                    }
                  },
                  "description": {
                    "type": "text",
                    "fields": {
                      "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                      }
                    }
                  },
                  "unit": {
                    "type": "keyword",
                    "ignore_above": 128
                  },
                  "kind": {
                    "type": "keyword",
                    "ignore_above": 128
                  },
                  "aggregationTemporality": {
                    "type": "keyword",
                    "ignore_above": 128
                  },
                  "monotonic": {
                    "type": "boolean"
                  },
                  "startTime": {
                    "type": "date"
                  },
                  "@timestamp": {
                    "type": "date"
                  },
                  "observedTimestamp": {
                    "type": "date_nanos"
                  },
                  "value@int": {
                    "type": "integer"
                  },
                  "value@double": {
                    "type": "double"
                  },
                  "buckets": {
                    "type" : "nested",
                    "properties": {
                      "count": {
                        "type": "long"
                      },
                      "sum": {
                        "type": "double"
                      },
                      "max": {
                        "type": "float"
                      },
                      "min": {
                        "type": "float"
                      }
                    }
                  },
                  "bucketCount": {
                    "type": "long"
                  },
                  "bucketCountsList": {
                    "type": "long"
                  },
                  "explicitBoundsList": {
                    "type": "float"
                  },
                  "explicitBoundsCount": {
                    "type": "float"
                  },
                  "quantiles": {
                    "properties": {
                      "quantile": {
                        "type": "double"
                      },
                      "value": {
                        "type": "double"
                      }
                    }
                  },
                  "quantileValuesCount": {
                    "type": "long"
                  },
                  "positiveBuckets": {
                    "type" : "nested",
                    "properties": {
                      "count": {
                        "type": "long"
                      },
                      "max": {
                        "type": "float"
                      },
                      "min": {
                        "type": "float"
                      }
                    }
                  },
                  "negativeBuckets": {
                    "type" : "nested",
                    "properties": {
                      "count": {
                        "type": "long"
                      },
                      "max": {
                        "type": "float"
                      },
                      "min": {
                        "type": "float"
                      }
                    }
                  },
                  "negativeOffset": {
                    "type": "integer"
                  },
                  "positiveOffset": {
                    "type": "integer"
                  },
                  "zeroCount": {
                    "type": "long"
                  },
                  "scale": {
                    "type": "long"
                  },
                  "max": {
                    "type": "float"
                  },
                  "min": {
                    "type": "float"
                  },
                  "sum": {
                    "type": "float"
                  },
                  "count": {
                    "type": "long"
                  },
                  "exemplar": {
                    "properties": {
                      "time": {
                        "type": "date"
                      },
                      "traceId": {
                        "ignore_above": 256,
                        "type": "keyword"
                      },
                      "serviceName": {
                        "ignore_above": 256,
                        "type": "keyword"
                      },
                      "spanId": {
                        "ignore_above": 256,
                        "type": "keyword"
                      }
                    }
                  },
                  "instrumentationScope": {
                    "properties": {
                      "name": {
                        "type": "keyword",
                        "ignore_above": 256
                      },
                      "version": {
                        "type": "keyword",
                        "ignore_above": 256
                      },
                      "droppedAttributesCount": {
                        "type": "integer"
                      },
                      "schemaUrl": {
                        "type": "text",
                        "fields": {
                          "keyword": {
                            "type": "keyword",
                            "ignore_above": 256
                          }
                        }
                      }
                    }
                  },
                  "schemaUrl": {
                    "type": "text",
                    "fields": {
                      "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                      }
                    }
                  }
                }
              },
              "aliases" : {
                "otel-metrics-" : {}
              },
              "settings": {
                "index": {
                  "mapping": {
                    "total_fields": {
                      "limit": 10000
                    }
                  },
                  "refresh_interval": "5s"
                }
              }
            },
            "composed_of": [],
            "version": 1,
            "_meta": {
              "description": "Observability Metrics Mapping Template",
              "catalog": "observability",
              "type": "metrics",
              "correlations" : [
                {
                  "field": "spanId",
                  "foreign-schema" : "traces",
                  "foreign-field" : "spanId"
                },
                {
                  "field": "traceId",
                  "foreign-schema" : "traces",
                  "foreign-field" : "traceId"
                }
              ]
            }
          }
